# SKBLAB.Nginx.Static.CI_CD
Тестовое задание №2 от SKBLAB

## Формулировка задачи

```
Нужно описать процедуру установки билда ангуляра на тестовый сервер nginx.
Билд ангуляра по сути является статическими файлами, которые nginx отдает из
определенной директории.
Тестовый сервер используют сразу несколько тестировщиков, и каждый хочет тестировать
свою задачу(ветку)
параллельно с остальными,
то есть должна быть возможность установить одновременно несколько билдов из разных
веток.
У тестировщика должна быть возможность откатиться к предыдущему установленному билду.
Описать свое видение процесса обновления через Jenkins.
```

## Решение

При описании решения я буду отталкиваться от того, что уже имеется подготовленный _тестовый сервер nginx_. 
Это исключает использование контейнеризации. Впрочем, в этой задаче она не даст сильных преимуществ, а лишь усложнит всю систему.

На сервере потребуется создать структуру каталогов для размещения собранного кода тестовых стендов. Это позволит описать в единой конфигурации nginx доступ до всех стендов. Пример конфигурации с использованием переменных:

```
server {
    server_name   ~^(www\.)?(?<branch>)\.(?<projectname>)\.localdomain\.ru$;

    location / {
        root   /sites/$projectname/$branch/current;
    }
}
```

Возможность отката к предыдущей версии билда можно организовать сохраняя на сервере nginx старые сборки кода и при необходимости переключать на них симлинк _current_. Например, тестировщик может переключить свою ветку на интересующий его в данный момент коммит и автоматика предоставит ему желаемую версию стенда.

Исходя из сказанного выше публикация стенда по задаче будет заключаться в следующих этапах:
- Jenkins фиксирует обновление в ветке разработчика и запускает процедуру создания/обновления стенда
- проверка наличия на сервере собранного ранее по HEAD-коммиту кода: если папка с id коммита есть на сервере, то пропускаем сборку и переключаем симлинк на неё
- тестирование кода в ветке
- сборка билда
- размещение билда ангуляра на сервере nginx в подкаталоге названном по id коммита в папке ветки внутри папки проекта
- переключение симлинка _current_ на свежую сборку
- проверка доступности стенда, например по коду ответа сервера
- в случае необходимости - чистка старых версий сборок
